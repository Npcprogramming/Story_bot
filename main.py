import logging
import sqlite3
import urllib.parse
from datetime import time
import pytz

from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    CallbackQueryHandler,
    ContextTypes,
)

# Настройка логирования
logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# ID создателя бота для отправки уведомлений и доступа к админ-панели
CREATOR_ID = 7033808522   # Замените на ваш Telegram ID

# Подключение к базе данных SQLite
conn = sqlite3.connect("users.db", check_same_thread=False)
cursor = conn.cursor()

# Создание таблицы пользователей, если она ещё не существует
cursor.execute(
    """
    CREATE TABLE IF NOT EXISTS users (
        id INTEGER PRIMARY KEY,
        username TEXT,
        referral_id INTEGER,
        referrals_count INTEGER DEFAULT 0,
        story_progress INTEGER DEFAULT 1
    )
    """
)
conn.commit()

# Функция генерации реферальной ссылки
def get_referral_link(bot_username: str, user_id: int) -> str:
    return f"https://t.me/{bot_username}?start={user_id}"

# Функция генерации частей истории
def get_story_part(progress):
    story = {
       
        2: {
            "text": (
                "Спасибо, что пригласил друзей!\n\n"
                "Теперь начинается настоящее повествование.\n\n"
                "Нажми 'Далее', чтобы продолжить."
            ),
            "photo": None,
            "audio": None,
            "button_text": "Далее",
            "callback_data": "continue_story",
        },
        3: {
            "text": (
                "Внизу приложена песня для максимального погружения. Я бы на твоем месте ее включил.\n\n"
                "Да начнется бесконечная история!\n\n"
                "Мэри и Джерри – два главных героя моего повествования. Хочу, чтобы ты придал им свои образы – это будет лучше, чем если я опишу лишь общие черты.\n\n"
                "Сейчас этих героев разделяет большое расстояние. Я даже не гарантирую, что это будет история о счастливой любви.\n\n"
                "Итак, Джерри с утра открыл почтовый ящик и увидел запечатанный конверт..."
            ),
            "photo": "photo1.jpg",
            "audio": "Spring.mp3",
            "button_text": "Читать дальше",
            "callback_data": "continue_story",
        },
        4: {
            "text": (
                "На конверте было написано: приглашение на свадебный банкет Эмили и Джорджи. "
                "Это близкие родственники Джерри, с которыми, судя по слухам, у него прекрасные отношения.\n\n"
                "Но Джерри никуда идти не собирался, на следующую неделю у него совсем другие планы – помочь своему дяде открыть местную пекарню.\n\n"
                "У этой пекарни будет особенность – во всех изделиях покупатели смогут найти записку с предсказанием.\n\n"
                "Ты подумаешь, что сейчас начинается стандартная история про записки с предсказаниями, но просто дай мне шанс. Обещаю, что не разочарую."
            ),
            "photo": None,
            "audio": None,
            "button_text": "Ну и что там дальше",
            "callback_data": "continue_story",
        },
        5: {
            "text": (
                "Время летит быстро. Джерри – не исключение. Пекарня открыта успешно. В первый день была лавина клиентов. Казалось бы, что может быть лучше?\n\n"
                "Давайте переместим воображаемую камеру в туалет этой пекарни, где Джерри – в холодном поту – дрожащими руками бьет себя по щекам, чтобы поскорее прийти в себя.\n\n"                
            ),
            "photo": None,
            "audio": None,
            "button_text": "Что с ним не так?",
            "callback_data": "continue_story",
        },
        6: {
            "text": (
                "Мы обязательно вернемся к Джерри и разберемся с его проблемой, но давайте немного отвлечемся на Мэри.\n\n"
                "Сегодня – 22 января – у нее день рождения. Вокруг собрались все – мама, дядя, родной брат и собака.\n\n"
                "Отца не было рядом. Он благополучно и безвозвратно ушел из семьи 10 лет назад.\n\n"
                "Мэри в последнее время потеряла интерес к чему-либо в этой жизни. Неизбежность смерти, отсутствие спутника – все давило на нее.\n\n"
                "Надеясь, что хотя бы в любимом человеке она найдет счастье, Мэри загадывает желание и задувает свечи.\n\n"
                "Вы действительно думаете, что они друг с другом встретятся? Думаете, что я настолько банален? \n\n"
                "Вернемся к Джерри?"
            ),
            "photo": None,
            "audio": None,
            "button_text": "Да, давай вернемся к Джерри",
            "callback_data": "continue_story",
        },
        7: {
            "text": (
                "Чтобы понять, что произошло с Джерри, нам придется взглянуть в прошлое. На 2 часа назад.\n\n"
                "Ресторан открылся, все в восторге. Даже наш главный герой, который только и живет такими моментами – это и есть его смысл жизни.\n\n"
                "Так, ради интереса он зашел на кухню, где повара неслись в полном хаосе с одного угла в другой. Все друг на друга орут, ругаются – это первый день.\n\n"
                "Весь этот ажиотаж приобретает для Джерри один тон, а его внимание концентрируется на свежем пирожном, которое так его и манило.\n\n"
                "За весь день он ничего не ел, так что выбор не заставил себя ждать."
            ),
            "photo": None,
            "audio": None,
            "button_text": "и на этом все?",
            "callback_data": "continue_story",
        },
        8: {
            "text": (
                "Конечно, на этом я бы заканчивать не стал, хотя было бы забавно.\n\n"
                "Естественно, Джерри напрочь забыл про записку с предсказанием внутри.\n\n"
                "Пока он жевал, бумажка знатно пострадала. Джерри это заметил и все же вытащил.\n\n"
                "На записке истертыми чернилами написано: \"Сегодня ты встретишь свою любовь\".\n\n"
                "Мысли об одиночестве нагнали на него жестокую паническую атаку. Последний раз он такое испытывал после смерти дедушки, с которым они были настоящими друзьями.\n\n"
                "Ну нет, вы все еще думаете, что я веду все линии к Мэри. Неужели вы настолько меня недооцениваете?"
            ),
            "photo": None,
            "audio": None,
            "button_text": "кстати, что там с Мэри?",
            "callback_data": "continue_story",
        },
        9: {
            "text": (
                "На последнем сеансе у психотерапевта Мэри посоветовали сменить обстановку.\n\n"
                "Прежде чем приступать к антидепрессантам, нужно убедиться - поможет ли ей небольшой курорт.\n\n"
                "Как же обрадовалась ее мама, которая как раз планировала 30-дневный отпуск в Лас-Вегасе - ведь с ней будет любимая дочь.\n\n"
                "Мама Мэри - довольно тревожная женщина, так что ее чемоданы были заранее приготовлены, а билеты куплены. Осталось сделать то же самое и для Мэри.\n\n"
                "Рейс Нью-Йорк - Лас-Вегас начнется через 2 часа."
            ),
            "photo": None,
            "audio": None,
            "button_text": "дай угадаю, Джерри в Вегасе?",
            "callback_data": "continue_story",
        },
        10: {
            "text": (
                "Да, в Вегасе. Но думаешь, что я их сведу?\n\n"
                "Они сами решат, что им делать. Я лишь предлагаю условия.\n\n"
                "Давайте посмотрим на ситуацию с Джерри глубже: в подростковом возрасте он страдал паническими атаками. С последнего такого инцидента прошло больше 7 лет, и он думал, что все позади.\n\n"
                "Видимо, мысли о том, что он никого в своей жизни так и не найдет, стали триггером к очередной панической атаке, в связи с чем ему пришлось отлучиться в туалет.\n\n"
                "Во время приступа Джерри испытал всю гамму плохих эмоций.\n\n"
                "Поэтому, уже опустошенный, он решает найти партнершу на сайте знакомств. Естественно, не для серьезных отношений. Просто присмотреться.\n\n"
                "Он посчитал, что записка в пирожном - это подсказка судьбы, чтобы нашел уже хоть кого-нибудь, плевать кого."                
            ),
            "photo": None,
            "audio": None,
            "button_text": "нашел в итоге?",
            "callback_data": "continue_story",
        },
        11: {
            "text": (
                "Долго ждать не пришлось. Буквально за час у него завязался душевный разговор с девушкой по имени Энни. Она его ровесница, так что все в порядке.\n\n"
                "Они словили общую волну. Да такую, что Джерри начал думать в более серьезном ключе.\n\n"
                "Джерри снял комнату в ближайшем отеле, потому что дома у него живет большая семья. Город дорогой для проживания, поэтому для них это идеальный вариант.\n\n"
                "Отель назывался \"Майлз-Таун\". Как только Энни услышала это название, она впала в растерянность и предложила выбрать отель \"Спринг\".\n\n"
                "В отель \"Спринг\" съезжается много туристов с Европы, поэтому для них там готовят лучшие условия.\n\n"
                "Джерри обрадовался, потому что они уже выбирали отель, а не обсуждали - стоит ли вообще снимать комнату."
            ),
            "photo": None,
            "audio": None,
            "button_text": "они так быстро встретились?",
            "callback_data": "continue_story",
        },
        12: {
            "text": (
                "Скажу даже больше - Джерри уже ждет, пока Энни выйдет с душа.\n\n"
                "Так весело он время давно не проводил.\n\n"
                "Энни оказалась легкомысленной девушкой. И дело даже не в том, что она так быстро встретилась с Джерри. Она подумала, что парень к ней взаимно холоден.\n\n"
                "Вода проходит по телу Энни, капли смешиваются, образуя целую катастрофу в душе. Это внешне вода течет гладко - на самом же деле там настоящий хаос.\n\n"
                "Такой же хаос творится в голове у Джерри. Он не ожидал, что так чувственно это воспримет.\n\n"
                "Но, чем выше поднимаются чувства, тем болезненнее они падают обратно. Джерри услышал уведомление.\n\n"
                "Его телефон отключен. Он взглянул налево и увидел очередное уведомление на телефоне Энни, которая поленилась в свое время поставить блокировку.\n\n"
                "Сообщение от Майкла: \"Может встретимся сегодня вечером? Прошлая ночь была жаркой\".\n\n"
                "Из душа выходит Энни..."
            ),
            "photo": None,
            "audio": None,
            "button_text": "неужели скандал?",
            "callback_data": "continue_story",
        },
        13: {
            "text": (
                "Джерри понимал головой, что эта девушка ему чужая, практически никто. Так же он осознавал, что ничего серьезного с ней не выйдет.\n\n"
                "Однако его мужское начало так и лезло наружу в виде давно забытого чувства, которое называется \"ревность\".\n\n"
                "Джерри спросил у Энни, что это за парень ей пишет. На что услышал уничтожающий рассудок ответ - мой парень, у нас свободные отношения.\n\n"
                "Наш герой, очевидно, втрескался в Энни, но, осознавая, что начинается нездоровая история, попросил Энни покинуть отель.\n\n"
                "Джерри один в апартаментах. Он на взводе. Энни напомнила ему о его слабости, никчемности, которые приравнивают его к животному.\n\n"
                "\"Неужели это и будет всей моей жизнью?\"\n\n"
                "На высоте эмоций Джерри громко закричал, сел, прижавшись к стене, и горько заревел.\n\n"
                "В дверь постучали..."
            ),
            "photo": None,
            "audio": None,
            "button_text": "это Мэри?",
            "callback_data": "continue_story",
        },
        14: {
            "text": (
                "Так получилось, что мама Мэри тоже была в курсе отеля \"Спринг\". Комната была куплена еще до попадания в Вегас.\n\n"
                "Поселились они в 313 номере - стенка к стенке с 312 номером, в котором пару часов назад поселился Джерри.\n\n"
                "Вещи разложены, Мэри разлеглась на большой кровати с белыми простынями.\n\n"
                "Такое мягкое и приятное ощущение, похожее на погружение в шоколадный торт. Мэри открыла глаза и слегка испугалась, увидев свое отражение в зеркале.\n\n"
                "В номерах отеля \"Спринг\" зеркала встроены в потолок. В зеркале 313 номера было видно только Мэри, а рядом - никого. Мужчиной даже не пахло.\n\n"
                "Резко выпрыгнув из кровати, Мэри впервые за долгое время решила обратиться к Богу\n\n"
                "\"Господь мой, я знаю, что Ты меня слышишь и понимаю, что во всем есть Твоя мудрость. Прошу, объясни. Где моя любовь? Могу ли я вообще кого-либо полюбить? Дай хоть какой-нибудь знак\"."
            ),
            "photo": None,
            "audio": None,
            "button_text": "знак был?",
            "callback_data": "continue_story",
        },
        15: {
            "text": (
                "В ответ - ничего. Ни света из окна, ни озарения. Ничего. Мэри окончательно разочаровалась, встала с колен и прыгнула обратно на кровать.\n\n"
                "Не прошло и минуты - из ванной в панике выбежала мама. Утверждает, что в соседнем номере она услышала громкий вопль, и, возможно, кому-то нужна помощь.\n\n"
                "Мэри увидела, как мама начинает набирать номер охраны отеля \"Спринг\".\n\n"
                "Она вспомнила свою молитву, выбежала в коридор и направилась к этому номеру.\n\n"
                "На недоумение мамы она возразила тем, что объяснит позже.\n\n"
                "Дверь в 312 номер была открыта, но Мэри, как воспитанный человек, решила все же постучать."
            ),
            "photo": None,
            "audio": None,
            "button_text": "ты все-таки их сводишь?",
            "callback_data": "continue_story",
        },
        16: {
            "text": (
                "Джерри, услышав стук в дверь, моментально прекратил рыдать.\n\n"
                "Он вытер слезы своим белоснежным халатом и немного приоткрыл дверь номера.\n\n"
                "В появившейся щели дверного проема он разглядел растерянную девушку, которая даже не знала, что сказать.\n\n"
                "Мэри думала, что все пойдет само, но оказалось, что нужно еще и говорить с ним.\n\n"
                "Она объяснила, что услышала крик и подумала, что ему нужна помощь. Захотела убедиться, так ли это.\n\n"
                "Джерри нейтрально ответил \"нет\" и закрыл дверь. Уже на ключ.\n\n"
                "Через минуту снова стук в дверь.\n\n"
                "Джерри снова приоткрыл и уже на высоких нотах хотел было спросить, что ей надо, но вместо девушки увидел двух высоких охранников отеля \"Спринг\".\n\n"
                "Отделавшись от них обоих, Джерри ворчливо подумал, что в этом отеле нельзя даже спокойно поплакать.\n\n"
                "Снова стук в дверь..."
            ),
            "photo": None,
            "audio": None,
            "button_text": "а это еще кто?",
            "callback_data": "continue_story",
        },
        17: {
            "text": (
                "Джерри снова открыл дверь своего номера.\n\n"
                "Перед ним предстала женщина лет 40-45, которая попросила прощения за произошедшее.\n\n"
                "\"Я лишь подумала, что кому-то понадобилась помощь, и не могла остаться в стороне.\"\n\n"
                "Чтобы искупить вину, прошу выпить с нами чаю, мы тут недавно заселились. Отказы не принимаются, мы как раз заказали лучшие пирожные этого города.\n\n"
                "На недоумение мамы она возразила тем, что объяснит позже.\n\n"
                "Говорят, что внутри них ставят бумажки с предсказаниями. Вот и проверим вместе\".\n\n"
                "Джерри через полчаса оказался уже в 313 номере. Уж сильно он падок на сладости. Тем более авторского производства, о чем еще не рассказал.\n\n"
                "Мэри не уводила взгляда с юноши - настолько он был обаятелен и хорош собой.\n\n"
                "Все открыли записки с предсказаниями..."
            ),
            "photo": None,
            "audio": None,
            "button_text": "читать дальше",
            "callback_data": "continue_story",
        },
        18: {
            "text": (
                "Естественно, в бумажках с предсказаниями не оказалось ничего особенного - это реальный мир, здесь не бывает сказочных случайностей. Наверное...\n\n"
                "Джерри не подавал признаков внимания в сторону девушки.\n\n"
                "Но в одну секунду все поменялось - когда Мэри налила ему еще одну чашку чая. Он случайно задел эту чашку рукой - у Джерри еще с подросткового возраста раздражительно дрожат кисти - на что Мэри спокойно отреагировала и с улыбкой вытерла мокрый пол.\n\n"
                "Джерри был сражен ее взглядом и искренней улыбкой. В ее глазах - неподкупный интерес, забота как о родном. Джерри давно такого не испытывал.\n\n"
                "Более того, Мэри имела замечательную внешность, так что Джерри не стал думать долго и осмелился пригласить ее на вечернюю прогулку по улицам Лас-Вегаса.\n\n"
                "Мэри - не дура. Было бы странно после всех предыдущих действий говорить \"нет\".\n\n"
                "На вечерней прогулке Джерри с ухмылкой подумал: \"Надо же, снова теплое ощущение в груди. Я думал, что после того случая мое сердце протухло окончательно. А оно, оказывается, вон что может. Зараза\".\n\n"
                "Мэри заметила эту ухмылку и почему-то не смогла сдержать смех. Настолько это ее позабавило.\n\n"
                "Еле прекратив свою истерику, она сказала Джерри: \"Знаешь, я давно так не смеялась. Причем ты даже не старался меня смешить.\n\n"
                "Я думала, что после крайнего расставания уже никогда ни с кем не повеселюсь\".\n\n"
                "Джерри посмотрел на воображаемую камеру, чтобы его воображаемые зрители вместе с ним удивились совпадению. Он предложил ей вернуться в \"Спринг\".\n\n"                
                "312 номер был снят лишь на несколько часов, а в 313 как раз нет мамы. У нее отпуск - полежать могла и в Нью-Йорке."
            ),
            "photo": None,
            "audio": None,
            "button_text": "пропустить постельную сцену",
            "callback_data": "continue_story",
        },
        19: {
            "text": (
                "Во встроенном в потолок зеркале отражалась уже не только Мэри.\n\n"
                "Я думаю, что вы насмотрелись достаточно мелодрам, чтобы сейчас снова прокручивать их счастливые свидания.\n\n"
                "И так очевидно, что они отлично провели время.\n\n"                
                "Она носила его рубашки, он дарил ей цветы в самые неожиданные моменты и так далее."
            ),
            "photo": None,
            "audio": None,
            "button_text": "промотай до семейной жизни, так уж и быть",
            "callback_data": "continue_story",
        },
        20: {
            "text": (
                "Да, тоже так думаю.\n\n"
                "Теперь у Джерри есть возможность жить в отдельном доме с Мэри, потому что пекарный бизнес растет как на дрожжах.\n\n"
                "Но Мэри все же замечает проскальзывающую печаль в глазах мужа.\n\n"
                "Уж больно чуткой она была, что иногда раздражало Джерри - у него не получалось скрывать от жены плохое настроение.\n\n"
                "На недоумение мамы она возразила тем, что объяснит позже.\n\n"
                "\"В последнее время я начала замечать, что ты подавлен. Ты замкнут в себе, перестал часто шутить\"\n\n"
                "\"Хех. Раньше ты жаловалась на мои шутки. А теперь хочешь, чтобы я чаще это делал?\n\n"
                "Извини, Мэри. Я не хотел язвить...\n\n"
                "Мне просто кажется, что город - это не мое. Я к нему не привязан, а у тебя здесь уже свой салон красоты. Ты ведь никогда это не бросишь. Ты так старалась\".\n\n"
                "\"А что ты предлагаешь, солнце? Если тебе так будет лучше, то можем немного пожить на природе.\n\n"
                "У нас достаточно возможностей, чтобы обустроить там свою жизнь.\n\n"
                "Там, где счастлив ты - счастлива и я\".\n\n"
                "Мэри - дочь своей матери: чемоданы собраны, бензобак заполнен до краев.\n\n"
                "Молодая семья отправляется в деревню \"Айтон\", к съемному домику напротив кристально чистой речки."
            ),
            "photo": None,
            "audio": None,
            "button_text": "можно пропустить дорогу?",
            "callback_data": "continue_story",
        },
        21: {
            "text": (
                "Близится рассвет. За рулем Джерри, хотя обычно водить любит Мэри.\n\n"
                "Путь к деревне был проложен через лесное шоссе. Транспорт здесь проезжает редко, но трасса была идеально ровной.\n\n"
                "Внезапно Мэри настигает ужас - она, кажется, оставила паспорта дома.\n\n"
                "Джерри решил отвлечься на пару секунд, чтобы открыть бардачок. Туда он заранее положил паспорта. Нутром чувствовал, что именно их она и забудет.\n\n"
                "На недоумение мамы она возразила тем, что объяснит позже.\n\n"
                "Мэри спокойна, а Джерри пропустил знак \"Дикие животные\".\n\n"
                "120 км/час. Сплошная прямая дорога. Справа и слева - протянутые леса и пробирающая кожу прохлада.\n\n"
                "\"Через 1 час лесная зона закончится, как раз застанем рассвет\" - Джерри застенчиво улыбнулся своей жене, на лице которой он увидел очередной ужас, но уже похлеще \"паспортного\".\n\n"
                "На дорогу выбежал дикий олень. В машине гробовая тишина. Резкий поворот налево. Машина совершила три переворота. Все еще  ни одного крика.\n\n"
                "Мэри еле-еле приходит в себя. В ушах писк особой частоты, какой даже в фильмах не услышать.\n\n"
                "Расплывчатые очертания вокруг собираются в четкий образ окровавленного Джерри."
            ),
            "photo": None,
            "audio": None,
            "button_text": "не может быть, что он умер",
            "callback_data": "continue_story",
        },
        22: {
            "text": (
                "Мэри собирает все силы, чтобы выйти из обезображенного автомобиля.\n\n"
                "У нее получается открыть дверцу со стороны водителя и вытащить свою любовь.\n\n"
                "Серьезных ранений она не заметила. Множественные ушибы и сотрясение - из-за которых ему понадобилось время, чтобы притий в себя.\n\n"
                "Какое замечательное обстоятельство - в этой зоне совсем нулевая сеть.\n\n"
                "Мэри погружена в глубокое отчаяние и шок. Ее пустые глаза не изливались слезами. Такое сложно осознать.\n\n"
                "\"Мэри, что произошло?\" - как же этих слов ей не хватало. Бальзам на сердце и душу. Наконец-то она не одна. Вместе с Джерри они преодолеют все.\n\n"
                "\"Мы попали в аварию. У тебя видимо, сильное сотрясение, раз не помнишь. Джерри, нам нужно что-то делать, выбираться к людям\".\n\n"
                "\"Здесь ловит сеть?\" - спросил Джерри и даже не стал дожидаться ответа. Было достаточно ответного взгляда.\n\n"
                "Джерри предложил быстренько оглядеться вокруг на признаки цивилизации.\n\n"
                "Время было еще темное, до восхода осталось 30 минут.\n\n"
                "Поэтому им не составило труда в метрах 150-200 разглядеть свет.\n\n"
                "Они посмотрели друг на друга и молчаливо приняли факт - другого выхода нет, придется идти."
            ),
            "photo": None,
            "audio": None,
            "button_text": "читать дальше",
            "callback_data": "continue_story",
        },
        23: {
            "text": (
                "До хижины осталось 50 метров. Было очевидно, что в таких местах электричество не проводится. Видимо, внутри было огромное количество свечей. Это очень опасно для деревянного домика.\n\n"
                "Джерри попросил жену остановиться, пока он разведает ситуацию - посмотрит в окно.\n\n"
                "Он медленно подошел к жилью. Наклонившись, немного выглянул из-за угла окошка. Внутри - странная картина: заправленная кровать, грязные тарелки на столе, вяленое мясо на противоположной стене.\n\n"
                "Здесь, без сомнений, кто-то живет. \"Видимо, хозяин на охоте, либо отлучился на другие дела\" - подумал Джерри.\n\n"
                "Жестом он показал Мэри, что она может аккуратно подойти ближе - махнул рукой в свою сторону.\n\n"
                "Мерри, в свою очередь, поняла, что нужно идти к мужу, но не уловила жест \"медленно\". По причине беглого шага она не заметила, как задела леску, привязанную к колокольчику.\n\n"
                "Видимо, хозяин хижины поставил ее, чтобы вовремя заметить диких зверей поблизости. Странно, что Джерри не зацепился за эту леску.\n\n"                
                "Было бы еще страннее, если бы после всего этого никто не пришел на место событий - Джерри слышит громкий выстрел из ружья..."
            ),
            "photo": None,
            "audio": None,
            "button_text": "зачем нужен выстрел?",
            "callback_data": "continue_story",
        },
        24: {
            "text": (
                "Выстрел - вполне логичное действие против диких зверей. Неожиданные и громкие звуки отпугивают медведей, коих здесь много. Поэтому человек решил застраховаться.\n\n"
                "Джерри посмотрел в глаза Мэри, которая была в 15 метрах от него. Он смахнул рукой в сторону дерева, которое было рядом с ней. Теперь она поняла все правильно - нужно за него спрятаться.\n\n"
                "Джерри пришлось максимально напрячь свои извилины. Хозяин дома обязательно подойдет - и дело даже не в колокольчиках, достаточно шума от аварии. У него ружье. За деревом прячется Мэри.\n\n"
                "Джерри начал улавливать странные звуки - похожие на одышку и быстрые шаги.\n\n"                
                "Понимая, что через секунды хозяин уже выйдет из-за угла дома, он решил крикнуть: \"Помогите\". После крика он вышел навстречу к мужчине..."
            ),
            "photo": None,
            "audio": None,
            "button_text": "читать дальше",
            "callback_data": "continue_story",
        },
        25: {
            "text": (
                "Он был одет в камуфляжную одежду со шкурой животного, которую он использовал как накидку. На удивление, мужчина был низкого роста. Джерри по-другому представлял лесных обитателей.\n\n"
                "Естественно, мужчина разузнал все о ситуации, после чего спросил: один ли он здесь. Джерри ответил, что один. Интуиция подсказывала ему, что нужно соврать. Его осторожность вполне разумна.\n\n"
                "Хозяин дома рассказал, что он здесь занимается охотой уже более 10 лет. Попросил прощения за то, что мог напугать своим выстрелом.\n\n"
                "\"Джерри, давай постараемся вместе разобраться. Здесь не ловит сеть, нет системы GPS, чтобы мы могли хоть с кем-либо связаться.\n\n"
                "Я думаю, что единственный вариант в твоем случае - жить пока у меня и каждый день выходить на дорогу, чтобы выбраться отсюда\".\n\n"
                "Наступило обреченное минутное молчание. Джерри думал: как поступить. Мэри на улице, а этому охотнику пока мало доверия..."
            ),
            "photo": None,
            "audio": None,
            "button_text": "читать дальше",
            "callback_data": "continue_story",
        },
        26: {
            "text": (
                "Хозяин прервал тишину: \"Мне все-таки кажется, что... Извини, чай закипел, я сейчас вернусь\".\n\n"
                "От дикого сотрясения Джерри мучала жажда, и отказаться хотя бы от глотка ароматного чая он не мог.\n\n"
                "Глоток. Выдох. Глоток - охотник расплылся в глазах. Джерри потерял сознание.\n\n"
                "Все это время Мэри - по примеру своего мужа - наблюдала за ситуацией через угол окошка.\n\n"
                "Какой же ужас ее настиг, когда она увидела, что после глотка чая Джерри отключился, а хозяин повел себя так, будто это и планировалось.\n\n"
                "Сердце стучит - будто разъяренный табун лошадей. Лицо охлажденное, бледное, зрачки - черная бездна. Нужно срочно что-либо предпринимать.\n\n"
                "Охотник оказался слишком доверчив, когда поверил словам Джерри о том, что он тут один. По старой привычке повесил свое ружье на крючок, вбитый со стороны входной двери.\n\n"
                "Для Мэри не составило никакого труда взять ружье и со всей шокирующей силой ворваться в внутрь..."
            ),
            "photo": None,
            "audio": None,
            "button_text": "читать дальше",
            "callback_data": "continue_story",
        },
        27: {
            "text": (
                "Благо, что на 21 день рождения дядя подарил ей замечательный подарок - ружье для совместной охоты. Охоты, к которой они готовились, но на которую так и не пошли.\n\n"
                "\"Что ты сделал с моим мужем?\"\n\n"
                "Охотник обомлел от страха. Встал на колени и начал умолять не убивать.\n\n"
                "\"Что ты сделал с моим мужем, ублюдок? Что ты сделал с моим Джерри? Считаю до трех и стреляю!\n\n"
                "Раз!\n\n"
                "Два!\"\n\n"
                "\"Стой! Я хочу ему помочь!\"\n\n"
                "\"Да что ты несешь, гребаный псих?..\"\n\n"
                "Охотник перебил и начал кричать сквозь слезы: \"Стой! Пожалуйста, послушай! Я ушел из общества, потому что чутко чувствую то же, что и люди вокруг. Я уже не мог это терпеть и ушел подальше от цивилизации...\"\n\n"
                "\"Ублюдок, верни Джерри в сознание! Джерри, ты меня слышишь?\"\n\n"
                "Джерри с полуоткрытыми глазами бормотал что-то непонятное. На фоне криков казалось, что он беззвучно двигает губами.\n\n"
                "\"Когда я увидел твоего мужа, в тот же момент почувствовал глубокую тоску. Уверен, что ты за ним такое замечала. Такое невозможно упрятать внутри. Он пожирает самого себя и много думает о своей смерти! Мне нужно ему помочь...\"\n\n"
                "\"Что ты с ним сделал?\"\n\n"                
                "Джерри слабым голосом прервал разговор: \"Мэри, стой\". Он все еще не мог двигаться..."
            ),
            "photo": None,
            "audio": None,
            "button_text": "читать дальше",
            "callback_data": "continue_story",
        },
        28: {
            "text": (
                "Мэри сама не заметила то, как близко она уже подошла к охотнику.\n\n"
                "\"Повернись ко мне спиной, живо!\"\n\n"
                "\"Прошу, не делай этого. Я только хотел помочь! Я умоляю, не убивай меня, умоляю. Я сделаю все, что ты скажешь. Прошу...\".\n\n"
                "\"Я сказала - повернулся спиной!\"\n\n"
                "\"Мэри, не убивай его\".\n\n"
                "Мэри не слышит. Но все же решает не стрелять. Резким замахом она бьет в затылок охотнику - теперь без сознания он.\n\n"
                "Мэри с особой тяжестью поднимает Джерри себе на плечи и бежит в сторону дороги.\n\n"
                "\"Ты его убила?\"\n\n"
                "\"Нет, Джерри. Нам нужно выбираться из этого сумасшедшего места\".\n\n"
                "Прошло около 30 минут. Издалека слышен звук автомобиля. Мэри выбегает на середину дороги - другой возможности у нее уже не будет.\n\n"
                "Вскоре стало ясно, что это был крупный желтый фургон, в котором путешествовала молодая семья:\n\n"
                "\"Дорогая, ты точно взяла паспорта?\"\n\n"
                "\"Да взяла я, уже сто раз спросил. Позволь уже себе расслабиться\".\n\n"
                "\"За рулем расслабляться нельзя, солнышко. Никогда\".\n\n"
                "\"Папа! Там девочка на дороге!\",\n\n"
                "\"О Господи. Дорогой, притормози\".\n\n"
                "Водитель выглядывает из окна, спустив стекло: \"Эй, девушка! Что с вами случилось?\""
            ),
            "photo": None,
            "audio": None,
            "button_text": "читать дальше",
            "callback_data": "continue_story",
        },
        29: {
            "text": (
                "\"Мы с мужем попали в аварию. Прошу, помогите выбраться отсюда. Если вы не поможете, то мы потеряем всю надежду на спасение\".\n\n"
                "Водитель фургона выбежал в их сторону, помог поднять Джерри и расположил их на свободном диване.\n\n"
                "\"Какие вещи остались в вашей машине? Давайте я все подниму сюда\".\n\n"
                "\"В багажнике наш общий чемодан. И в бардачке два паспорта - мой и Джерри. Спасибо вам огромное, мистер...\"\n\n"
                "\"Зовите меня просто Джек. Это моя семья - жена Сьюзан и дочь Стефани\".\n\n"
                "\"Мэри, кто все эти люди?\" - Джерри, наконец, пришел в себя. Головокружение не прошло, но подняться в силах он уже был.\n\n"
                "\"Джерри, твоя жена - настоящий герой\" - сказала Сьюзан с настоящей тревожностью на лице.\n\n"
                "\"Джерри, тот охотник тебя отравил какой-то заразой. Нам помогла эта замечательная семья. Теперь все будет хорошо\".\n\n"
                "\"Мэри, мне уже хорошо\".\n\n"
                "\"Конечно, от такой лошадиной дозы кому угодно будет хорошо\".\n\n"
                "\"Нет, ты не понимаешь, у меня было видение\".\n\n"
                "Что за видение?.."
            ),
            "photo": None,
            "audio": None,
            "button_text": "читать дальше",
            "callback_data": "continue_story",
        },
        30: {
            "text": (
                "Водитель вернулся: \"У вас в чемодане мешки с цементом? Так, вот ваши паспорта. Куда держите путь?\"\n\n"
                "Солнце уже давно поднялось и через лобовое стекло  агрессивно слепило Мэри: \"Нам в деревню Айтон, но достаточно, если довезете до ближайшей транспортной станции. Уже плевать куда, главное - в людное место\".\n\n"
                "\"Вы шутите? Нет, вы точно издеваетесь - мы тоже держим курс в сторону этой деревушки! У нас там своя дача около речки!\"\n\n"
                "\"Значит, счастливой нам поездки, мистер Джек. Ой, то есть просто Джек\".\n\n"
                "\"Просто\" Джек заметил, что муж Мэри уже пришел в себя. Они познакомились друг с другом. Джек выразил огромную благодарность их семье и обещал, что без щедрого вознаграждения это не оставит. На вопрос любопытной Сьюзан про охотника Джерри ответил, что объяснит позже - по дороге.\n\n"
                "\"Мама, а что такое видения?\"\n\n"
                "Услышав слова дочери Джека, Мэри вернулась к разговору с Джерри: \"Дорогой, что за видения у тебя были?\"\n\n"
                "\"Я уже не уверен, что это стоит здесь обсуждать\".\n\n"
                "\"Дорогой, эти люди спасли нам жизнь. Думаю, что ничего страшного, если они тоже послушают\".\n\n"
                "Сьюзан добавила уже в улыбчивом тоне: \"Да, а то мы с Джеком умирали от скуки. Мы, конечно, не это имели в виду, когда хотели развеяться, но это даже лучше\".\n\n"                
                "Джерри начал:"
            ),
            "photo": None,
            "audio": None,
            "button_text": "читать дальше",
            "callback_data": "continue_story",
        },
        31: {
            "text": (
                "\"В тот момент, когда тело уже было парализовано и вокруг стояла кромешная тьма, я осознал, что остался один на один со своим сознанием.\n\n"
                "Я не мог думать ни о чем, кроме того факта, что остался один. Никаких отвлеченных мыслей. В таком состоянии я пробыл около часа.\n\n"
                "Раздражение не заставило себя долго ждать - оно шло изнутри, как логичная и естественная реакция на происходящее.\n\n"
                "Впервые за целый час мне пришла в голову вторая мысль - взглянуть на свое тело. Мой взгляд перешел вниз, но тело отсутствовало. Будто я чертов призрак.\n\n"
                "Я поднимаю взгляд и направляю его вдаль, где зажегся красный свет. Он, как на театральной сцене, освещал таинственного человека, до жути похожего на меня.\n\n"
                "Это была моя третья мысль. Как только я отвлекся на эту мысль и вернулся обратно к наблюдению, то понял, что уже нахожусь напротив него.\n\n"
                "Он ответил на вопрос, который я не задал, но о котором я тогда точно подумал: \n\n"
                "\"Я и ты - диаметрально противоположные люди, похожие только внешне. Я тот, кем ты должен стать внутренне\".\n\n"                
                "Я все еще не мог говорить, поэтому продолжил слушать его речь, подобную ржавому кинжалу, вонзающемуся в брюхо:"
            ),
            "photo": None,
            "audio": None,
            "button_text": "что за вопрос?",
            "callback_data": "continue_story",
        },
        32: {
            "text": (
                "\"Я - тот, кто не завидует своему брату. Вспомни конверт с приглашением на свадьбу. Ты говорил всем вокруг, что очень рад за них. Кричал в каждом углу, что любишь его. Но что в итоге? \n\n"
                "Ты даже не подумал прийти туда. В самый важный для него день ты не оказался рядом. Я - тот, кто не завидует своему брату и действительно желает ему лучшего.\n\n"
                "Смотри, что в моих руках - это пирожное, которое ты зажевал вместе с предсказанием 4 года назад.\n\n"
                "Попробуй предсказать: куда вас приведет история с охотником через год? Хотя бы через день. Сейчас ты не можешь говорить, но даже если бы владел всеми языками мира, то не смог бы предсказать и доли того, что произойдет на самом деле.\n\n"
                "Я - тот, кто принял свое бессилие перед событиями вокруг. Я - лишь речной обитатель, который плывет туда, куда ему укажет вода. И признание этого делает меня сильным.\n\n"
                "Я - тот, чье сердце снова бьется в полную силу. И бьется оно благодаря Мэри - та, кого я так долго искал всю жизнь.\n\n"
                "Моя первая любовь совершила ошибку, когда ушла от меня. Она имела право ее совершить, но блага этого мира не перед ее ногами. И я рад, что они перед ногами Мэри. Она этого точно заслуживает.\n\n"
                "Все еще не понимаешь, кто я?\""
            ),
            "photo": None,
            "audio": None,
            "button_text": "читать дальше",
            "callback_data": "continue_story",
        },
        33: {
            "text": (
                "\"Я обнаружил, что мое тело вернулось обратно. Напротив - никого.\n\n"
                "Джерри попросил жену остановиться, пока он разведает ситуацию - посмотрит в окно.\n\n"
                "Хватило около 5 секунд, чтобы осознать - теперь под красным светом стою я.\n\n"
                "Я посмотрел на руки, которые обычно дрожали - они держались ровно, почти в хирургическом спокойствии.\n\n"
                "К тому же я был удивлен, что ранее часто стучавшее сердце уже не паниковало. В голове - кристальная чистота. Ноль навязчивых мыслей.\n\n"
                "Мэри, какое же облегчение - я наконец-то разобрался в себе! Я будто все время ходил с мечом в позвонках, а теперь строен и смирен!\n\n"
                "Ты лучшее, что со мной случалось! Извини меня, если давал повод сомневаться в этом.\n\n"                
                "О чем ты думаешь, Мэри?\""
            ),
            "photo": None,
            "audio": None,
            "button_text": "читать дальше",
            "callback_data": "continue_story",
        },
        34: {
            "text": (
                "Мэри крепко обняла своего мужа. Ее слова вышли лишь в виде одной счастливой слезы. И этого было достаточно.\n\n"
                "Водитель прервал драматическую сцену: \"Сьюзан рассказала мне про какого-то охотника. Что за охотник?\"\n\n"
                "С этого момента началась поездка в сторону деревушки Айтон.\n\n"
                "Может быть, эта встреча была не случайной. Кто знает - к чему это приведет?\n\n"
                "Обращение к читателю - если вы чувствуете то же, что и Джерри, то обязательно обратитесь к близкому человеку или к психотерапевту. \n\n"                                
                "Все можно исправить. Все можно облегчить."
            ),
            "photo": None,
            "audio": None,
            "button_text": "конец?",
            "callback_data": "continue_story",
        },
        35: {
            "text": (
                "Как я и обещал в самом начале - эта история бесконечна. \n\n"
                "Но в этом нет смысла без читателей. Если увижу, что людей заинтересовало, то начну выпускать продолжение:\n\n"
                "В этом же боте. Ежедневно. В 22:00 по МСК. Начиная с 1 марта.\n\n"
                "Так что постарайся распространить ссылку на этого бота всем знакомым. Вот она: @HotelSpringBot\n\n"                                
                "Этим ты очень сильно поможешь❤️"
            ),
            "photo": None,
            "audio": None,
            "button_text": None,
            "callback_data": None,
        },

    }
    return story.get(progress)

# Функция обновления рефералов для владельца ссылки
async def update_referral(ref_id: int, context: ContextTypes.DEFAULT_TYPE) -> bool:
    cursor.execute("UPDATE users SET referrals_count = referrals_count + 1 WHERE id = ?", (ref_id,))
    conn.commit()
    cursor.execute("SELECT referrals_count, story_progress FROM users WHERE id = ?", (ref_id,))
    data = cursor.fetchone()
    
    if data:
        referrals_count, story_progress = data
        logger.info(f"Владелец ссылки {ref_id} имеет {referrals_count} приглашённых (story_progress={story_progress})")
        
        # Уведомление создателя бота о новом реферале
        await context.bot.send_message(
            chat_id=CREATOR_ID,
            text=f"У пользователя с ID {ref_id} теперь {referrals_count} приглашённых!"
        )
        
        if referrals_count >= 2 and story_progress == 1:
            cursor.execute("UPDATE users SET story_progress = 2 WHERE id = ?", (ref_id,))
            conn.commit()
            logger.info(f"Обновлён story_progress для пользователя {ref_id} на 2")
            return True
    return False

# Обработка команды /start
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    username = update.effective_user.username or update.effective_user.first_name
    args = context.args[0] if context.args else None

    # Проверяем, зарегистрирован ли пользователь
    cursor.execute("SELECT * FROM users WHERE id = ?", (user_id,))
    user = cursor.fetchone()

    if not user:
        ref_id = int(args) if args and args.isdigit() else None
        cursor.execute(
            "INSERT INTO users (id, username, referral_id) VALUES (?, ?, ?)",
            (user_id, username, ref_id),
        )
        conn.commit()
        logger.info(f"Зарегистрирован новый пользователь {user_id} (реферал от {ref_id})")

        # Уведомление создателя бота о новом пользователе
        await context.bot.send_message(
            chat_id=CREATOR_ID,
            text=f"Новый пользователь: {username} (ID: {user_id})"
        )

        if ref_id:
            if await update_referral(ref_id, context):
                story_part = get_story_part(2)
                keyboard = None
                if story_part.get("button_text") and story_part.get("callback_data"):
                    keyboard = InlineKeyboardMarkup(
                        [[InlineKeyboardButton(story_part["button_text"], callback_data=story_part["callback_data"])]]
                    )
                await context.bot.send_message(
                    chat_id=ref_id,
                    text=story_part["text"],
                    reply_markup=keyboard
                )
    else:
        logger.info(f"Пользователь {user_id} уже зарегистрирован.")

    cursor.execute("SELECT story_progress FROM users WHERE id = ?", (user_id,))
    result = cursor.fetchone()
    if result and result[0] > 1:
        keyboard = InlineKeyboardMarkup(
            [[InlineKeyboardButton("Продолжить читать", callback_data="continue_story")]]
        )
        await update.message.reply_text("Добро пожаловать! Ваш доступ подтверждён – история доступна.", reply_markup=keyboard)
        return

    bot_username = context.bot.username
    referral_link = get_referral_link(bot_username, user_id)
    share_text = (
        "Привет, я тут читаю прикольный рассказ Отель \"Спринг\".\n\n"
        "Но для продолжения нужно, чтобы ты тоже стал читателем и пригласил двух знакомых.\n\n"
        "Это проверенный бот. Выручи, пожалуйста.\n\nВот ссылка:"
    )
    
    encoded_text = urllib.parse.quote(share_text)
    encoded_link = urllib.parse.quote(referral_link)
    share_url = f"https://t.me/share/url?url={encoded_link}&text={encoded_text}"
    keyboard = InlineKeyboardMarkup([[InlineKeyboardButton("📩 Поделиться с друзьями", url=share_url)]])
    
    await update.message.reply_text(
        "Приветствую, дорогой читатель.\n\n"
        "Чтобы погрузиться в захватывающую историю, отправь приглашение двум знакомым.\n\n"
        "Вот кнопка👇",
        reply_markup=keyboard
    )

# Обработка команды /help
async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    # Если владелец бота, показываем админ-панель с кнопкой [Пользователи]
    if user_id == CREATOR_ID:
        keyboard = InlineKeyboardMarkup([
            [InlineKeyboardButton("Сколько Пользователей", callback_data="show_users")]
        ])
        await update.message.reply_text("Панель администратора:", reply_markup=keyboard)
    else:
        # Для остальных пользователей выводим справку без команды /count
        await update.message.reply_text(
            "/start - Начать историю\n"
            "/stats - Ваша статистика приглашений\n"
            "/help - Показать это сообщение"
        )

# Команда /count для вывода общего количества пользователей (только для владельца бота)
async def count_users(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_user.id != CREATOR_ID:
        await update.message.reply_text("У вас нет доступа к этой команде.")
        return
    cursor.execute("SELECT COUNT(*) FROM users")
    total_users = cursor.fetchone()[0]
    await update.message.reply_text(f"Общее количество пользователей: {total_users}")

# Callback для продолжения истории
async def continue_story(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    user_id = query.from_user.id

    cursor.execute("SELECT story_progress FROM users WHERE id = ?", (user_id,))
    result = cursor.fetchone()
    if not result:
        await query.message.reply_text("Ошибка: пользователь не найден.")
        return

    current_progress = result[0]
    new_progress = current_progress + 1
    cursor.execute("UPDATE users SET story_progress = ? WHERE id = ?", (new_progress, user_id))
    conn.commit()

    # Отправка уведомления владельцу бота о продолжении истории данным пользователем
    await context.bot.send_message(
        chat_id=CREATOR_ID,
        text=f"Пользователь {user_id} продолжил историю. Новый прогресс: {new_progress}"
    )

    story_part = get_story_part(new_progress)
    keyboard = None
    if story_part.get("button_text") and story_part.get("callback_data"):
        keyboard = InlineKeyboardMarkup(
            [[InlineKeyboardButton(story_part["button_text"], callback_data=story_part["callback_data"])]]
        )

    if story_part.get("photo"):
        await query.message.reply_photo(
            photo=story_part["photo"],
            caption=story_part["text"],
            reply_markup=keyboard
        )
    else:
        await query.message.reply_text(story_part["text"], reply_markup=keyboard)

# Команда /stats для проверки статистики пользователя
async def stats(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    cursor.execute("SELECT referrals_count, story_progress FROM users WHERE id = ?", (user_id,))
    result = cursor.fetchone()
    if not result:
        await update.message.reply_text("Пользователь не найден. Запустите /start для регистрации.")
        return
    referrals_count, story_progress = result
    await update.message.reply_text(f"Ваша статистика:\nПриглашено друзей: {referrals_count}\nПрогресс истории: Часть {story_progress}")

# Дополнительная команда /admin для панели администратора (для владельца бота)
async def admin_panel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_user.id != CREATOR_ID:
        await update.message.reply_text("У вас нет доступа к этой команде.")
        return
    keyboard = InlineKeyboardMarkup([
        [InlineKeyboardButton("[Пользователи]", callback_data="show_users")]
    ])
    await update.message.reply_text("Панель администратора:", reply_markup=keyboard)

# Callback для обработки кнопки "[Пользователи]"
async def show_users_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    if query.from_user.id != CREATOR_ID:
        await query.edit_message_text("У вас нет доступа к этой функции.")
        return
    cursor.execute("SELECT COUNT(*) FROM users")
    total_users = cursor.fetchone()[0]
    await query.edit_message_text(f"Общее количество пользователей: {total_users}")

# Ежедневное напоминание пользователям, чей рассказ ещё не дочитан до конца
async def daily_reminder(context: ContextTypes.DEFAULT_TYPE):
    cursor.execute("SELECT id, story_progress FROM users")
    users = cursor.fetchall()
    for user in users:
        user_id, story_progress = user
        part = get_story_part(story_progress)
        if part["text"] != "История закончена.":
            try:
                await context.bot.send_message(
                    chat_id=user_id,
                    text="Обращение от автора - предлагаю продолжить историю, если сегодня еще не начинал😌"
                )
            except Exception as e:
                logger.error(f"Ошибка отправки напоминания пользователю {user_id}: {e}")

def main():
    token = "7513399282:AAFX_mhtAb_UkzpGPcELWDavQ6suTiQ_OBU"  # Замените на реальный токен вашего бота
    application = ApplicationBuilder().token(token).build()

    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("stats", stats))
    application.add_handler(CommandHandler("count", count_users))
    application.add_handler(CommandHandler("help", help_command))
    application.add_handler(CommandHandler("admin", admin_panel))  # Команда для владельца бота
    application.add_handler(CallbackQueryHandler(continue_story, pattern="continue_story"))
    application.add_handler(CallbackQueryHandler(show_users_callback, pattern="show_users"))

    # Планирование ежедневного напоминания в 19:00 по МСК
    moscow_tz = pytz.timezone("Europe/Moscow")
    reminder_time = time(hour=19, minute=0, second=0, tzinfo=moscow_tz)
    application.job_queue.run_daily(daily_reminder, reminder_time, name="daily_reminder")

    logger.info("Бот запущен...")
    async def main():
    # Удаление вебхука перед запуском polling
    await application.bot.delete_webhook(drop_pending_updates=True)

    # Запуск бота в режиме polling
    await application.run_polling()

    application.run_polling()

if __name__ == "__main__":
    main()
